class AduroStoveCard extends HTMLElement {
  constructor() {
    super();
    this._pendingTempValue = null;
  }

  set hass(hass) {
    if (!this._initialized) {
      this._initialize();
    }
    
    this._hass = hass;
    this._updateContent();
  }

  setConfig(config) {
    if (!config.entity) {
      throw new Error('Please define an entity');
    }
    this._config = config;
    console.log('Card configured with entity:', config.entity);
  }

  _initialize() {
    this._initialized = true;
    
    const card = document.createElement('ha-card');
    card.innerHTML = `
      <style>
        .card-content {
          padding: 0;
        }
        
        /* Header Section */
        .header-section {
          background: white;
          padding: 20px;
          color: #333;
        }
        
        .header-top {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }
        
        .header-title {
          font-size: 24px;
          font-weight: 600;
        }
        
        .status-icons {
          display: flex;
          gap: 8px;
          align-items: center;
        }
        
        .status-icon {
          width: 28px;
          height: 28px;
          animation: spin 2s linear infinite;
          transform-origin: center center;
        }
        
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        
        .hidden {
          display: none;
        }
        
        .status-display {
          background: rgba(0, 0, 0, 0.05);
          backdrop-filter: blur(10px);
          border-radius: 12px;
          padding: 12px 16px;
          margin-bottom: 12px;
        }
        
        .status-main {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 4px;
          color: #333;
        }
        
        .status-sub {
          font-size: 14px;
          opacity: 0.7;
          color: #333;
        }
        
        .display-format {
          background: rgba(0, 0, 0, 0.05);
          backdrop-filter: blur(10px);
          border-radius: 12px;
          padding: 12px 16px;
          font-size: 20px;
          font-weight: 600;
          color: #333;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        
        .display-updating {
          font-size: 12px;
          opacity: 0.7;
        }
        
        /* Info Cards Section */
        .info-section {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
          padding: 16px;
          background: var(--card-background-color);
        }
        
        .info-card {
          background: var(--secondary-background-color);
          border-radius: 12px;
          padding: 12px;
          text-align: center;
          border: 1px solid var(--divider-color);
        }
        
        .info-label {
          font-size: 12px;
          color: var(--secondary-text-color);
          margin-bottom: 4px;
        }
        
        .info-value {
          font-size: 18px;
          font-weight: 600;
          color: var(--primary-text-color);
        }
        
        /* Pellet Section */
        .pellet-section {
          padding: 16px;
          background: var(--card-background-color);
        }
        
        .pellet-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }
        
        .pellet-label {
          font-size: 14px;
          font-weight: 500;
          color: var(--primary-text-color);
        }
        
        .refill-count {
          font-size: 12px;
          color: var(--secondary-text-color);
          background: var(--secondary-background-color);
          padding: 4px 12px;
          border-radius: 12px;
        }
        
        .pellet-bar {
          height: 40px;
          background: var(--divider-color);
          border-radius: 20px;
          overflow: hidden;
          position: relative;
        }
        
        .pellet-fill {
          height: 100%;
          background: var(--primary-color);
          transition: width 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--text-primary-color);
          font-weight: 700;
          font-size: 16px;
        }
        
        .pellet-fill.low {
          background: var(--error-color);
        }
        
        /* Control Buttons Section */
        .control-buttons {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
          padding: 0 16px 16px 16px;
        }
        
        .control-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          padding: 14px;
          border: 1px solid var(--divider-color);
          border-radius: 12px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.2s;
          background: var(--secondary-background-color);
          color: var(--primary-text-color);
        }
        
        .control-btn:active {
          transform: scale(0.95);
        }
        
        .control-btn.toggle-btn {
          background: var(--secondary-background-color);
          color: var(--secondary-text-color);
          border: 1px solid var(--divider-color);
        }
        
        .control-btn.toggle-btn.on {
          background: var(--primary-color);
          color: var(--text-primary-color);
          border: 1px solid var(--primary-color);
        }
        
        /* Adjusters Section */
        .adjusters-section {
          padding: 0 16px 16px 16px;
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }
        
        .adjuster-card {
          background: var(--card-background-color);
          border: 1px solid var(--divider-color);
          border-radius: 12px;
          padding: 12px;
        }
        
        .adjuster-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }
        
        .adjuster-label {
          font-size: 12px;
          font-weight: 500;
          color: var(--primary-text-color);
        }
        
        .adjuster-value {
          font-size: 14px;
          font-weight: 600;
          color: var(--primary-color);
        }
        
        .adjuster-controls {
          display: grid;
          grid-template-columns: auto 1fr auto;
          gap: 8px;
          align-items: center;
        }
        
        .adjuster-btn {
          width: 32px;
          height: 32px;
          border: 1px solid var(--divider-color);
          border-radius: 8px;
          background: var(--secondary-background-color);
          color: var(--primary-text-color);
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: transform 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .adjuster-btn:active {
          transform: scale(0.9);
        }
        
        .adjuster-display {
          text-align: center;
          font-size: 20px;
          font-weight: 700;
          color: var(--primary-text-color);
        }
        
        /* Action Buttons */
        .action-section {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
          padding: 0 16px 16px 16px;
        }
        
        .action-btn {
          padding: 16px;
          border: 1px solid var(--divider-color);
          border-radius: 12px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          background: var(--secondary-background-color);
          color: var(--primary-text-color);
        }
        
        .action-btn:hover {
          background: var(--primary-color);
          color: var(--text-primary-color);
          border-color: var(--primary-color);
        }
        
        .action-btn:active {
          transform: scale(0.95);
        }
        
        ha-icon {
          --mdc-icon-size: 20px;
        }
      </style>
      
      <div class="card-content">
        <!-- Header Section -->
        <div class="header-section">
          <div class="header-top">
            <div class="header-title">Aduro Stove</div>
            <div class="status-icons">
              <ha-icon class="status-icon hidden" id="change-icon" icon="mdi:sync"></ha-icon>
            </div>
          </div>
          
          <div class="status-display">
            <div class="status-main" id="status-main">-</div>
            <div class="status-sub" id="status-sub">-</div>
          </div>
          
          <div class="display-format">
            <div id="display-format">-</div>
            <div class="display-updating hidden" id="updating-text">Updating...</div>
          </div>
        </div>
        
        <!-- Info Cards -->
        <div class="info-section">
          <div class="info-card">
            <div class="info-label">Smoke Temperature</div>
            <div class="info-value" id="smoke-temp">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Pellets Left</div>
            <div class="info-value" id="pellet-percent">-</div>
          </div>
        </div>
        
        <!-- Pellet Bar -->
        <div class="pellet-section">
          <div class="pellet-header">
            <div class="pellet-label">Pellet Level</div>
            <div class="refill-count" id="refill-counter">0 refills since cleaning</div>
          </div>
          <div class="pellet-bar">
            <div class="pellet-fill" id="pellet-fill">0%</div>
          </div>
        </div>
        
        <!-- Control Buttons -->
        <div class="control-buttons">
          <button class="control-btn toggle-btn" id="power-btn">
            <ha-icon icon="mdi:power"></ha-icon>
            <span>Power</span>
          </button>
          <button class="control-btn" id="toggle-mode-btn">
            <ha-icon icon="mdi:sync"></ha-icon>
            <span>Toggle Mode</span>
          </button>
        </div>
        
        <!-- Heat Level Adjuster -->
        <div class="adjusters-section">
          <div class="adjuster-card">
            <div class="adjuster-header">
              <div class="adjuster-label">Heat Level</div>
              <div class="adjuster-value" id="heat-level-display">-</div>
            </div>
            <div class="adjuster-controls">
              <button class="adjuster-btn" id="heat-down">−</button>
              <div class="adjuster-display" id="heat-level-value">3</div>
              <button class="adjuster-btn" id="heat-up">+</button>
            </div>
          </div>
          
          <!-- Temperature Adjuster -->
          <div class="adjuster-card">
            <div class="adjuster-header">
              <div class="adjuster-label">Target Temperature</div>
            </div>
            <div class="adjuster-controls">
              <button class="adjuster-btn" id="temp-down">−</button>
              <div class="adjuster-display" id="temp-value">20°C</div>
              <button class="adjuster-btn" id="temp-up">+</button>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-section">
          <button class="action-btn" id="clean-btn">
            <ha-icon icon="mdi:broom"></ha-icon>
            <span>Stove Cleaned</span>
          </button>
          <button class="action-btn" id="refill-btn">
            <ha-icon icon="mdi:reload"></ha-icon>
            <span>Pellets Refilled</span>
          </button>
          <button class="control-btn toggle-btn" id="auto-resume-btn">
            <ha-icon icon="mdi:play-circle"></ha-icon>
            <span>Auto Resume</span>
          </button>
          <button class="control-btn toggle-btn" id="auto-shutdown-btn">
            <ha-icon icon="mdi:power-settings"></ha-icon>
            <span>Auto Shutdown</span>
          </button>
        </div>
      </div>
    `;
    
    this.appendChild(card);
    this._setupEventListeners();
  }

  _getEntityId(suffix, domain = null) {
    // Extract base name from entity (e.g., "sensor.aduro_h2" -> "aduro_h2")
    const baseEntity = this._config.entity;
    const parts = baseEntity.split('.');
    const baseName = parts.length > 1 ? parts[1] : parts[0];
    
    // Map internal names to actual entity names
    const entityMap = {
      // Switches
      'power': 'switch.power',
      'auto_shutdown': 'switch.auto_shutdown_at_low_pellets',
      'auto_resume_wood': 'switch.auto_resume_after_wood_mode',
      
      // Numbers
      'heatlevel': 'number.heat_level',
      'temperature': 'number.target_temperature',
      'pellet_capacity': 'number.pellet_capacity',
      'notification_level': 'number.low_pellet_notification_level',
      'shutdown_level': 'number.auto_shutdown_pellet_level',
      
      // Buttons
      'toggle_mode': 'button.toggle_mode',
      'refill_pellets': 'button.refill_pellets',
      'clean_stove': 'button.clean_stove',
      'resume_after_wood': 'button.resume_after_wood_mode',
      'force_auger': 'button.force_auger',
      
      // Sensors
      'status_main': 'sensor.status_main',
      'status_sub': 'sensor.status_sub',
      'change_in_progress': 'sensor.change_in_progress',
      'display_format': 'sensor.display_format',
      'smoke_temp': 'sensor.smoke_temperature',
      'pellet_percentage': 'sensor.pellet_percentage',
      'refill_counter': 'sensor.refill_counter',
    };
    
    const mapped = entityMap[suffix];
    if (mapped) {
      const [mappedDomain, mappedName] = mapped.split('.');
      return `${mappedDomain}.${baseName}_${mappedName}`;
    }
    
    // Fallback for unmapped entities
    if (!domain) {
      domain = 'sensor';
    }
    return `${domain}.${baseName}_${suffix}`;
  }

  _setupEventListeners() {
    // Power button
    this.querySelector('#power-btn').addEventListener('click', () => {
      const entityId = this._getEntityId('power');
      this._hass.callService('switch', 'toggle', { entity_id: entityId });
    });

    // Toggle mode button
    this.querySelector('#toggle-mode-btn').addEventListener('click', () => {
      const entityId = this._getEntityId('toggle_mode');
      this._hass.callService('button', 'press', { entity_id: entityId });
    });

    // Auto resume button
    this.querySelector('#auto-resume-btn').addEventListener('click', () => {
      const entityId = this._getEntityId('auto_resume_wood');
      this._hass.callService('switch', 'toggle', { entity_id: entityId });
    });

    // Auto shutdown button
    this.querySelector('#auto-shutdown-btn').addEventListener('click', () => {
      const entityId = this._getEntityId('auto_shutdown');
      this._hass.callService('switch', 'toggle', { entity_id: entityId });
    });

    // Heat level controls
    const heatUpBtn = this.querySelector('#heat-up');
    heatUpBtn.addEventListener('click', (e) => {
      const entityId = this._getEntityId('heatlevel');
      const currentEntity = this._hass.states[entityId];
      if (currentEntity) {
        const currentValue = parseFloat(currentEntity.state);
        const newValue = Math.min(currentValue + 1, 3);
        this._hass.callService('number', 'set_value', { 
          entity_id: entityId,
          value: newValue
        });
      }
      setTimeout(() => e.currentTarget.blur(), 100);
    });

    const heatDownBtn = this.querySelector('#heat-down');
    heatDownBtn.addEventListener('click', (e) => {
      const entityId = this._getEntityId('heatlevel');
      const currentEntity = this._hass.states[entityId];
      if (currentEntity) {
        const currentValue = parseFloat(currentEntity.state);
        const newValue = Math.max(currentValue - 1, 1);
        this._hass.callService('number', 'set_value', { 
          entity_id: entityId,
          value: newValue
        });
      }
      setTimeout(() => e.currentTarget.blur(), 100);
    });

    // Temperature controls
    const tempUpBtn = this.querySelector('#temp-up');
    tempUpBtn.addEventListener('click', (e) => {
      const entityId = this._getEntityId('temperature');
      const currentEntity = this._hass.states[entityId];
      if (currentEntity) {
        // Use pending value if available, otherwise use actual value
        const currentValue = this._pendingTempValue !== null ? this._pendingTempValue : parseFloat(currentEntity.state);
        const newValue = Math.min(currentValue + 1, 35);
        
        // Update display immediately
        this._pendingTempValue = newValue;
        this.querySelector('#temp-value').textContent = `${newValue}°C`;
        
        // Send command
        this._hass.callService('number', 'set_value', { 
          entity_id: entityId,
          value: newValue
        });
        
        // Clear pending value after 5 seconds
        clearTimeout(this._tempTimeout);
        this._tempTimeout = setTimeout(() => {
          this._pendingTempValue = null;
          this._updateContent();
        }, 5000);
      }
      setTimeout(() => e.currentTarget.blur(), 100);
    });

    const tempDownBtn = this.querySelector('#temp-down');
    tempDownBtn.addEventListener('click', (e) => {
      const entityId = this._getEntityId('temperature');
      const currentEntity = this._hass.states[entityId];
      if (currentEntity) {
        // Use pending value if available, otherwise use actual value
        const currentValue = this._pendingTempValue !== null ? this._pendingTempValue : parseFloat(currentEntity.state);
        const newValue = Math.max(currentValue - 1, 5);
        
        // Update display immediately
        this._pendingTempValue = newValue;
        this.querySelector('#temp-value').textContent = `${newValue}°C`;
        
        // Send command
        this._hass.callService('number', 'set_value', { 
          entity_id: entityId,
          value: newValue
        });
        
        // Clear pending value after 5 seconds
        clearTimeout(this._tempTimeout);
        this._tempTimeout = setTimeout(() => {
          this._pendingTempValue = null;
          this._updateContent();
        }, 5000);
      }
      setTimeout(() => e.currentTarget.blur(), 100);
    });

    // Action buttons
    this.querySelector('#clean-btn').addEventListener('click', () => {
      const entityId = this._getEntityId('clean_stove');
      this._hass.callService('button', 'press', { entity_id: entityId });
    });

    this.querySelector('#refill-btn').addEventListener('click', () => {
      const entityId = this._getEntityId('refill_pellets');
      this._hass.callService('button', 'press', { entity_id: entityId });
    });
  }

  _updateContent() {
    if (!this._hass || !this._config) return;

    // Debug: Log all available entities that match our pattern
    const baseEntity = this._config.entity;
    const parts = baseEntity.split('.');
    const baseName = parts.length > 1 ? parts[1] : parts[0];
    
    console.log('Looking for entities matching:', baseName);
    const matchingEntities = Object.keys(this._hass.states).filter(e => e.includes(baseName));
    console.log('All matching entities:', matchingEntities); // Show all

    // Update status displays
    const statusMainEntity = this._hass.states[this._getEntityId('status_main')];
    if (statusMainEntity) {
      this.querySelector('#status-main').textContent = statusMainEntity.state;
    }

    const statusSubEntity = this._hass.states[this._getEntityId('status_sub')];
    if (statusSubEntity) {
      this.querySelector('#status-sub').textContent = statusSubEntity.state;
    }

    // Update change in progress
    const changeInProgressEntity = this._hass.states[this._getEntityId('change_in_progress')];
    const changeIcon = this.querySelector('#change-icon');
    const updatingText = this.querySelector('#updating-text');
    
    if (changeInProgressEntity && changeInProgressEntity.state === 'true') {
      changeIcon.classList.remove('hidden');
      updatingText.classList.remove('hidden');
    } else {
      changeIcon.classList.add('hidden');
      updatingText.classList.add('hidden');
    }

    // Update display format
    const displayFormatEntity = this._hass.states[this._getEntityId('display_format')];
    if (displayFormatEntity) {
      this.querySelector('#display-format').textContent = displayFormatEntity.state;
    }

    // Update smoke temperature
    const smokeTempEntity = this._hass.states[this._getEntityId('smoke_temp')];
    if (smokeTempEntity && smokeTempEntity.state !== 'unavailable') {
      const temp = Math.round(parseFloat(smokeTempEntity.state));
      this.querySelector('#smoke-temp').textContent = `${temp}°C`;
    } else {
      this.querySelector('#smoke-temp').textContent = 'N/A';
    }

    // Update pellet percentage
    const pelletEntity = this._hass.states[this._getEntityId('pellet_percentage')];
    if (pelletEntity) {
      const percentage = parseInt(pelletEntity.state) || 0;
      this.querySelector('#pellet-percent').textContent = `${percentage}%`;
      
      const pelletFill = this.querySelector('#pellet-fill');
      pelletFill.style.width = `${percentage}%`;
      pelletFill.textContent = `${percentage}%`;
      
      if (percentage <= 20) {
        pelletFill.classList.add('low');
      } else {
        pelletFill.classList.remove('low');
      }
    }

    // Update refill counter
    const refillCounterEntity = this._hass.states[this._getEntityId('refill_counter')];
    if (refillCounterEntity) {
      const count = parseInt(refillCounterEntity.state) || 0;
      this.querySelector('#refill-counter').textContent = `${count} refills since cleaning`;
    }

    // Update power button
    const powerEntity = this._hass.states[this._getEntityId('power')];
    const powerBtn = this.querySelector('#power-btn');
    if (powerEntity && powerEntity.state === 'on') {
      powerBtn.classList.add('on');
    } else {
      powerBtn.classList.remove('on');
    }

    // Update auto resume button
    const autoResumeEntity = this._hass.states[this._getEntityId('auto_resume_wood')];
    const autoResumeBtn = this.querySelector('#auto-resume-btn');
    if (autoResumeEntity && autoResumeEntity.state === 'on') {
      autoResumeBtn.classList.add('on');
    } else {
      autoResumeBtn.classList.remove('on');
    }

    // Update auto shutdown button
    const autoShutdownEntity = this._hass.states[this._getEntityId('auto_shutdown')];
    const autoShutdownBtn = this.querySelector('#auto-shutdown-btn');
    if (autoShutdownEntity && autoShutdownEntity.state === 'on') {
      autoShutdownBtn.classList.add('on');
    } else {
      autoShutdownBtn.classList.remove('on');
    }

    // Update heat level
    const heatLevelEntity = this._hass.states[this._getEntityId('heatlevel')];
    if (heatLevelEntity) {
      const level = parseInt(heatLevelEntity.state);
      this.querySelector('#heat-level-value').textContent = level;
    }

    // Update temperature
    const tempEntity = this._hass.states[this._getEntityId('temperature')];
    if (tempEntity) {
      // Use pending value if available, otherwise use actual value
      const temp = this._pendingTempValue !== null ? this._pendingTempValue : parseFloat(tempEntity.state);
      this.querySelector('#temp-value').textContent = `${temp}°C`;
    }
  }

  getCardSize() {
    return 8;
  }
}

customElements.define('aduro-stove-card', AduroStoveCard);

window.customCards = window.customCards || [];
window.customCards.push({
  type: 'aduro-stove-card',
  name: 'Aduro Stove Card',
  description: 'A custom card for controlling Aduro stoves'
});
